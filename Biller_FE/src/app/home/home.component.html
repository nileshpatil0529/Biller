<div class="container mt-3">
  <form *ngIf="showInvoiceForm" [formGroup]="invoiceForm">
    <mat-card>
      <mat-card-content>
        <div class="invoice-form">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Client</mat-label>
            <mat-select formControlName="clientId">
              <mat-option [value]="null">None</mat-option>
              <mat-option *ngFor="let client of clients" [value]="client.id">{{ client.name }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="form-field" *ngIf="isEditMode">
            <mat-label>Invoice #</mat-label>
            <input matInput formControlName="invoiceNumber" readonly />
          </mat-form-field>
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Location</mat-label>
            <mat-select formControlName="location">
              <mat-option *ngFor="let loc of locations" [value]="loc">{{ loc }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Payment Mode</mat-label>
            <mat-select formControlName="paymentMode">
              <mat-option *ngFor="let mode of paymentModes" [value]="mode">{{ mode }}</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Discount</mat-label>
            <div class="mat-btn-group sell-qty-group pointer-all">
              <button mat-stroked-button color="warn" class="qty-btn" type="button" (click)="decrementDiscount()">-</button>
              <input type="number" min="0" step="0.01" matInput formControlName="discount" class="qty-input" />
              <span>%</span>
              <button mat-stroked-button color="primary" class="qty-btn" type="button" (click)="incrementDiscount()">+</button>
            </div>
          </mat-form-field>
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Payment Status</mat-label>
            <mat-select formControlName="paymentStatus">
              <mat-option *ngFor="let status of paymentStatuses" [value]="status">{{ status }}</mat-option>
            </mat-select>
          </mat-form-field>
          <div class="form-actions-with-total">
            <span class="grand-total-display">Grand Total: {{ grandTotal | number:'1.2-2' }}</span>
            <div>
              <button mat-stroked-button color="warn" type="button" (click)="onCancel()">
                Cancel
              </button>
              <button mat-raised-button color="primary" type="button" (click)="onPrintInvoice()" [disabled]="invoiceForm.invalid">
                Print
              </button>
              <!-- Edit button calls backend PUT /api/invoices/:invoiceNumber -->
              <button mat-raised-button color="accent" type="button" *ngIf="isEditMode && !editClicked" (click)="onEditInvoice()" [disabled]="invoiceForm.invalid">
                Edit
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
      <div *ngIf="isEditMode">
        <div class="table-responsive">
          <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">
            <ng-container matColumnDef="code">
              <th mat-header-cell *matHeaderCellDef>Product Code</th>
              <td mat-cell *matCellDef="let product">{{ product.code }}</td>
            </ng-container>
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Product Name</th>
              <td mat-cell *matCellDef="let product">{{ product.name }}</td>
            </ng-container>
            <ng-container matColumnDef="unit">
              <th mat-header-cell *matHeaderCellDef>Unit</th>
              <td mat-cell *matCellDef="let product">{{ product.unit }}</td>
            </ng-container>
            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Price</th>
              <td mat-cell *matCellDef="let product">{{ product.price }}</td>
            </ng-container>
            <ng-container matColumnDef="sell_qty">
              <th mat-header-cell *matHeaderCellDef>Qty</th>
              <td mat-cell *matCellDef="let product">
                <div class="mat-btn-group sell-qty-group pointer-all">
                  <button mat-stroked-button color="warn" class="qty-btn" type="button" (click)="handleQtyButton(product, 'decrement', $event)">-</button>
                  <input type="number" min="0" step="0.01" matInput [value]="product.sell_qty" (input)="onSellQtyInput(product, $event)" class="qty-input" />
                  <button mat-stroked-button color="primary" class="qty-btn" type="button" (click)="handleQtyButton(product, 'increment', $event)">+</button>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="totalValue">
              <th mat-header-cell *matHeaderCellDef>Sub Total</th>
              <td mat-cell *matCellDef="let product">{{ product.totalValue }}</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="['code','name','unit','price','sell_qty','totalValue']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['code','name','unit','price','sell_qty','totalValue']"></tr>
          </table>
        </div>
      </div>
    </mat-card>
  </form>
  <div class="top-bar-row" *ngIf="!showInvoiceForm && !isEditMode">
    <!-- Options button dropdown removed -->
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search Products</mat-label>
      <input #searchInput type="text" matInput [matAutocomplete]="auto" [(ngModel)]="productSearch" (ngModelChange)="applyFilterAutocomplete($event)" placeholder="Type to search..." />
      <button mat-icon-button matSuffix (click)="clearFilterAutocomplete(); $event.preventDefault(); $event.stopPropagation();">
        <mat-icon>close</mat-icon>
      </button>
      <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayProduct">
        <mat-option *ngFor="let product of filteredProducts" [value]="product" [disabled]="true" class="autocomplete-option-table">
          <table class="autocomplete-table pointer-none">
            <tr>
              <td class="name-col">{{ product.name }}</td>
              <td class="price-col">â‚¹{{ product.price }}</td>
              <td class="actions-col">
                <div class="mat-btn-group sell-qty-group pointer-all">
                  <button mat-stroked-button color="warn" class="qty-btn" (click)="handleQtyButton(product, 'decrement', $event, true)">-</button>
                  <input type="number" min="0" step="0.01" [value]="product.sell_qty || 0" (input)="onSellQtyInput(product, $event); $event.stopPropagation();" name="sell_qty" class="qty-input" />
                  <button mat-stroked-button color="primary" class="qty-btn" (click)="handleQtyButton(product, 'increment', $event, true)">+</button>
                </div>
              </td>
            </tr>
          </table>
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>
  </div>
  <div *ngIf="dataSource.filteredData.length > 0 && !showInvoiceForm && !isEditMode" class="form-actions-with-total">
    <span class="grand-total-display">Grand Total: {{ grandTotal | number:'1.2-2' }}</span>
    <div style="display: flex; gap: 8px; margin-left: auto;">
      <button mat-stroked-button color="warn" (click)="clearAllSellQty()">
        Clear
      </button>
      <button mat-raised-button color="primary" (click)="showInvoiceForm = true">
        <mat-icon>add</mat-icon> Invoice
      </button>
    </div>
  </div>
  <div class="table-responsive my-3" *ngIf="!showInvoiceForm && !isEditMode">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z2 w-100 products-table">
      <ng-container matColumnDef="totalValue">
        <th mat-header-cell *matHeaderCellDef>Sub Total</th>
        <td mat-cell *matCellDef="let product">
          {{ ((product.sell_qty || 0) * product.price) | number:'1.2-2' }}
        </td>
      </ng-container>
      <ng-container matColumnDef="code">
        <th mat-header-cell *matHeaderCellDef>Product Code</th>
        <td mat-cell *matCellDef="let product; let i = index">
          <form *ngIf="
              (addingRow && i === 0) || (showForm && editingProduct === product);
              else showCode
            " [formGroup]="productForm" class="d-inline">
            <input matInput formControlName="code" class="form-control form-control-sm" />
          </form>
          <ng-template #showCode>{{ product.code }}</ng-template>
        </td>
      </ng-container>
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Product Name (Eng)</th>
        <td mat-cell *matCellDef="let product; let i = index">
          <form *ngIf="
              (addingRow && i === 0) || (showForm && editingProduct === product);
              else showName
            " [formGroup]="productForm" class="d-inline">
            <input matInput formControlName="name" class="form-control form-control-sm" />
          </form>
          <ng-template #showName>{{ product.name }}</ng-template>
        </td>
      </ng-container>
      <ng-container matColumnDef="unit">
        <th mat-header-cell *matHeaderCellDef>Unit</th>
        <td mat-cell *matCellDef="let product; let i = index">
          <form *ngIf="
              (addingRow && i === 0) || (showForm && editingProduct === product);
              else showUnit
            " [formGroup]="productForm" class="d-inline">
            <select matInput formControlName="unit" class="form-control form-control-sm">
              <option value="">Select Unit</option>
              <option *ngFor="let u of units" [value]="u">{{ u }}</option>
            </select>
          </form>
          <ng-template #showUnit>{{ product.unit }}</ng-template>
        </td>
      </ng-container>
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>Price</th>
        <td mat-cell *matCellDef="let product; let i = index">
          <form *ngIf="
              (addingRow && i === 0) || (showForm && editingProduct === product);
              else showPrice
            " [formGroup]="productForm" class="d-inline">
            <input matInput type="number" formControlName="price" class="form-control form-control-sm" />
          </form>
          <ng-template #showPrice>{{ product.price }}</ng-template>
        </td>
      </ng-container>
      <ng-container matColumnDef="stockQty">
        <th mat-header-cell *matHeaderCellDef>Stock Qty</th>
        <td mat-cell *matCellDef="let product; let i = index">
          <form *ngIf="
              (addingRow && i === 0) || (showForm && editingProduct === product);
              else showStock
            " [formGroup]="productForm" class="d-inline">
            <input matInput type="number" formControlName="stockQty" class="form-control form-control-sm" />
          </form>
          <ng-template #showStock>{{ product.stockQty }}</ng-template>
        </td>
      </ng-container>
      <ng-container matColumnDef="qty">
        <th mat-header-cell *matHeaderCellDef>Qty</th>
        <td mat-cell *matCellDef="let product; let i = index">
          <ng-container *ngIf="(addingRow && i === 0) || (showForm && editingProduct === product); else showQtyValue">
            <div class="mat-btn-group sell-qty-group pointer-all">
              <button mat-stroked-button color="warn" class="qty-btn" (click)="handleQtyButton(product, 'decrement', $event)">-</button>
              <input type="number" min="0" [value]="product.sell_qty || 0" (input)="onSellQtyInput(product, $event); $event.stopPropagation();" name="sell_qty" class="qty-input" />
              <button mat-stroked-button color="primary" class="qty-btn" (click)="handleQtyButton(product, 'increment', $event)">+</button>
            </div>
          </ng-container>
          <ng-template #showQtyValue>
            {{ product.sell_qty || 0 }}
          </ng-template>
          <ng-container *ngIf="addingRow && i === 0">
            <button mat-button color="primary" (click)="saveProduct()">
              Save
            </button>
            <button mat-button color="warn" (click)="cancelNewRow()">
              Cancel
            </button>
          </ng-container>
          <ng-container *ngIf="showForm && editingProduct === product">
            <button mat-button color="primary" (click)="saveProduct()">
              Save
            </button>
            <button mat-button color="warn" (click)="closeForm()">
              Cancel
            </button>
          </ng-container>
          <ng-container *ngIf="
              !(addingRow && i === 0) &&
              !(showForm && editingProduct === product)
            ">
            <!-- Edit and Delete buttons removed -->
          </ng-container>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      <!-- No data row removed; message will be shown below the table -->
    </table>
  </div>
  <div *ngIf="dataSource.filteredData.length === 0" class="no-data-message">No data available.</div>
</div>